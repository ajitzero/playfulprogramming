---
import { Client, discordSort, GatewayIntentBits, TextChannel } from "discord.js";
import Document from "../layouts/document.astro";
import DiscordMessage from "components/discord-message/discord-message.astro";

// Create a new client instance
const client = new Client({
	intents: [
		GatewayIntentBits.Guilds,
		GatewayIntentBits.GuildMessages,
		GatewayIntentBits.MessageContent,
		GatewayIntentBits.GuildEmojisAndStickers
	],
});

// Log in to Discord with your client's token
await client.login(import.meta.env.DISCORD_TOKEN);

// Replace 'YOUR_GUILD_ID' with your actual guild ID
const guild = await client.guilds.fetch(import.meta.env.DISCORD_GUILD_ID);
if (!guild) {
	return Astro.redirect("/404");
}

const channels = await guild.channels.fetch();
const channel = Array.from(channels.values()).find(
	(ch) => ch?.name === "webdev" && ch?.isTextBased(),
) as TextChannel;

if (!channel) {
	return Astro.redirect("/404");
}

const messagesCollection = await channel.messages.fetch({ limit: 10 });
const messagesArr = Array.from(messagesCollection.values()).sort(
	(a, b) => a.createdTimestamp - b.createdTimestamp,
);

async function lookupUserName(id: string) {
	const user = await guild.members.fetch(id);
	return user.displayName;
}
---

<Document>
	<ul>
		{messagesArr.map((message) => <DiscordMessage content={message.content} lookupUserName={lookupUserName}/>)}
	</ul>
</Document>
